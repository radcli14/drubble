# Equation of Motion
def PlayerAndStool(t,u):
    # Resolve the States
    l = u[2]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
    th = u[3]
    s = np.sin(th)
    c = np.cos(th)
    dl = u[6]
    dth = u[7]
    q = np.matrix([u[0],u[1],u[2],u[3]])
    dq = np.matrix([u[4],u[5],u[6],u[7]])
    q = q.T
    dq = dq.T

    # Mass Matrix
    M = np.matrix([[mc+mg  ,   0   ,-mg*s,-mg*l*c],
                   [  0    , mc+mg , mg*c,-mg*l*s],
                   [-mg*s  , mg*c  , mg  ,   0   ],
                   [-mg*l*c,-mg*l*s,  0  , mg*l*l]])

    # Damping Matrix     
    C = np.diag([Cx,Cy,Cl,Ct])
    
    # Stiffness Matrix
    K = np.diag([0 ,Ky,Kl,Kt])
    
    # Frequency Check
    # V,D = np.linalg.eig(M.I*K)
    # print("omega^2 = ",V)
    # print("freq    = ",np.sqrt(V)/2/np.pi)
    # print("phi     = \n",D)
    
    # Coriolis and Centripetal Force Vector
    D = np.matrix([[-2*mg*dl*dth*c+mg*l*dth*dth*s], 
                   [-2*mg*dl*dth*s+mg*l*dth*dth*c], 
                   [0],
                   [0]])
    
    # Gravitational Force Vector
    G = np.matrix([[0],
                   [m*g],
                   [mg*g*c],
                   [-mg*g*l*s]])         

    # Equation of Motion
    RHS = -C*dq-K*q+K*q0-D-G+Q
    ddq = M.I*RHS
    
    # Output State Derivatives
    du = [u[4],u[5],u[6],u[7],ddq[0,0],ddq[1,0],ddq[2,0],ddq[3,0]]
    return du

def stickDude(n):
    # States at time t[n]
    x = sol.y[0,n]
    y = sol.y[1,n]
    l = sol.y[2,n]
    th = sol.y[3,n]
    s = np.sin(th)
    sp = np.sin(th+0.25)
    sm = np.sin(th-0.25)
    c = np.cos(th)
    cp = np.cos(th+0.25)
    cm = np.cos(th-0.25)
    v = sol.y[4,n]

    # Right Foot [rf] Left Foot [lf] Positions
    rf = [x+(v/vx)*np.sin(x+3*np.pi/2), 0.2*(v/vx)*(1+np.sin(x+3*np.pi/2))]
    lf = [x+(v/vx)*np.cos(x), 0.2*(v/vx)*(1+np.cos(x))]
    
    # Right Knee [rk] Left Knee [lk] Positions
    
    # Waist Position
    w = [x,y-d]
    
    # Shoulder Position
    sh = [x,y+d]
    
    # Right Hand [rh] Left Hand [lh] Position 
    rh = [x-0.5*l*sp,y+d+0.5*l*cp]
    lh = [x-0.5*l*sm,y+d+0.5*l*cm]
    
    # Stool Center Position
    sc = [x-l*s,y+d+l*c]
    
    # Plotting vectors
    xv = [rf[0],w[0],lf[0],w[0],sh[0],rh[0],sh[0],lh[0],sh[0],sc[0]]
    yv = [rf[1],w[1],lf[1],w[1],sh[1],rh[1],sh[1],lh[1],sh[1],sc[1]]
    
    return xv,yv,rf,lf


def init():
    fig = plt.figure()
    ax = fig.add_subplot(111)
    ax.set_aspect('equal')

def animate(n):
    # Get the plotting vectors using plotDude function
    xv,yv,rf,lf = stickDude(n)

    # Generate plot at time t[n]
    plt.plot(xv,yv)
    plt.plot(rf[0],rf[1],'kv')
    plt.plot(lf[0],lf[1],'k^')
    plt.xlim([x-4.5,x+0.5])
    plt.ylim([y-2.1,y+1.9])